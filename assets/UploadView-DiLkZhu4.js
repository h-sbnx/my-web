import{_ as G,c as H,a as c,b as o,w as n,r as f,o as C,d,h as K,t as v,j as Y,e as m,i as Z,E as a,k as D,l as F}from"./index-DoGM4jZS.js";const J={class:"upload-page"},P={class:"upload-container"},Q={class:"workid-input-group"},X={class:"file-result-container"},ee={class:"file-name"},h="http://localhost:8080/api",te={__name:"UploadView",setup(le){const i=Z({workId:""}),x=m(!1),g=m([]),k=m(!1),p=m(!1),N={workId:[{required:!0,message:"请输入作品ID",trigger:"blur"},{pattern:/^[A-Za-z0-9]+$/,message:"作品ID仅支持字母和数字",trigger:"blur"}],file:[{required:!0,validator:(t,e,r)=>{u.value.length===0?r(new Error("请选择要上传的文件")):r()},trigger:"change"}]},I=m(null),w=m(null),u=m([]),E=`${h}/file/upload`,U=async()=>{try{const t=await D.get(`${h}/file/queryByWorkId`,{params:{workId:i.workId}});return(t.data||t).code===200}catch{return!1}},$=t=>{const e=t.name;if(!e)return a.error("文件名不能为空！"),!1;if(!i.workId.trim())return a.error("请先填写作品ID再选择文件！"),!1;if(!e.startsWith(i.workId+"_"))return F({title:"格式提示",message:`文件名格式错误！正确格式：${i.workId}_队伍名称`,type:"warning"}),!1;const r=[".zip",".rar",".doc",".docx",".pdf"],l=e.substring(e.lastIndexOf(".")).toLowerCase();return r.includes(l)?!0:(a.error(`文件格式不支持！仅支持：${r.join("、")}`),!1)},S=t=>t.size/1024/1024<200?i.workId.trim()?$(t)?!0:(a.error("文件名校验失败，请检查文件名格式！"),!1):(a.error("请先填写作品ID！"),!1):(a.error("文件大小不能超过200MB！"),!1),M=async()=>{I.value.validate(async t=>{if(!t){a.error("请完善表单信息！");return}if(u.value.length===0){a.warning("请先选择文件！");return}const e=u.value[0].raw||u.value[0];if(!$(e)){a.error("文件校验不通过，无法上传！");return}p.value=!0;const r=await U();if(p.value=!1,!r){a.error("作品ID不存在，无法上传");return}p.value=!0,w.value&&w.value.submit()})},L=t=>{if(p.value=!1,console.log("上传成功返回：",t),!t){a.error("上传结果异常，请检查文件状态"),b();return}t.code===200?F({title:"上传成功",message:`作品上传成功！
文件UUID：${t.data||"未返回"}`,type:"success"}).then(()=>{b(),i.workId?.trim()&&B()}).catch(()=>{b()}):(a.error(`上传失败：${t.message||"未知错误"}`),u.value=[])},R=t=>{p.value=!1;let e="网络异常，请重试";t.response?e=t.response.data?.message||`请求失败（${t.response.status}）`:t.request?e="服务器无响应，请检查网络或联系管理员":e=`请求异常：${t.message||"未知错误"}`,a.error(`上传失败：${e}`),u.value=[]},b=()=>{I.value&&I.value.resetFields(),u.value=[],w.value&&w.value.clearFiles(),g.value=[],k.value=!1,p.value=!1,a.info("表单已重置")},B=async()=>{if(!i.workId.trim()){a.warning("请先输入作品ID！");return}x.value=!0,k.value=!1,g.value=[];try{const t=await D.get(`${h}/file/queryByWorkId`,{params:{workId:i.workId}}),e=t.data||t;e.code===200?(g.value=e.data||[],k.value=!0,g.value.length===0?a.info("该作品ID暂无已提交的文件"):a.success(`查询成功，共找到 ${g.value.length} 个文件`)):a.error(`查询失败：${e.message||"服务器返回异常"}`)}catch(t){console.error("查询异常详情：",t);const r=(t.response?.data||t.response||{}).message||"网络异常，查询失败";a.error(`查询失败：${r}`)}finally{x.value=!1}},V=t=>{if(!t||!t.fileUuid){a.error("文件信息不存在，无法预览");return}const e=t.originalFileName.substring(t.originalFileName.lastIndexOf(".")).toLowerCase(),r=`${h}/file/download?fileUuid=${t.fileUuid}`;if(e===".pdf")window.open(r,"_blank");else if([".doc",".docx",".zip",".rar"].includes(e))F.confirm(`是否下载文件：${t.originalFileName}`,"文件下载",{confirmButtonText:"下载",cancelButtonText:"取消"}).then(()=>{const l=document.createElement("a");l.href=r,l.download=t.originalFileName,document.body.appendChild(l),l.click(),document.body.removeChild(l),a.success("开始下载文件")}).catch(()=>{a.info("已取消下载")});else{const l=document.createElement("a");l.href=r,l.download=t.originalFileName,document.body.appendChild(l),l.click(),document.body.removeChild(l)}},q=t=>{if(!t||t<=0)return"0 B";const e=["B","KB","MB","GB"];let r=0,l=t;for(;l>=1024&&r<e.length-1;)l/=1024,r++;return`${l.toFixed(2)} ${e[r]}`},z=t=>{if(!t)return"-";const e=new Date(t);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},T=(t,e)=>{if(e.length>0){const r=e[0].raw||e[0];if(!$(r)){w.value?.clearFiles(),u.value=[];return}}u.value=e};return(t,e)=>{const r=f("el-input"),l=f("el-button"),y=f("el-form-item"),_=f("el-table-column"),W=f("el-table"),O=f("el-upload"),j=f("el-form"),A=f("el-card");return C(),H("div",J,[c("div",P,[e[7]||(e[7]=c("h2",{class:"page-title"},"作品提交",-1)),o(A,{class:"upload-card"},{default:n(()=>[o(j,{model:i,rules:N,ref_key:"uploadFormRef",ref:I,"label-width":"100px",class:"upload-form"},{default:n(()=>[o(y,{label:"作品ID：",prop:"workId"},{default:n(()=>[c("div",Q,[o(r,{modelValue:i.workId,"onUpdate:modelValue":e[0]||(e[0]=s=>i.workId=s),placeholder:"请输入作品ID"},null,8,["modelValue"]),o(l,{type:"info",onClick:B,loading:x.value,style:{"margin-left":"10px"}},{default:n(()=>[...e[1]||(e[1]=[d(" 查询已提交作品 ",-1)])]),_:1},8,["loading"])])]),_:1}),k.value?(C(),K(y,{key:0,label:"已提交作品："},{default:n(()=>[c("div",X,[o(W,{data:g.value,border:"",style:{width:"100%"},"empty-text":"暂无已提交的作品文件",class:"file-table"},{default:n(()=>[o(_,{label:"序号",align:"center",width:"80"},{default:n(s=>[d(v(s.$index+1),1)]),_:1}),o(_,{label:"文件名",prop:"originalFileName","min-width":"200"},{default:n(s=>[c("span",ee,v(s.row.originalFileName),1)]),_:1}),o(_,{label:"文件大小",align:"center",width:"120"},{default:n(s=>[d(v(q(s.row.fileSize)),1)]),_:1}),o(_,{label:"文件类型",align:"center",width:"120"},{default:n(s=>[d(v(s.row.fileType||s.row.originalFileName.substring(s.row.originalFileName.lastIndexOf("."))),1)]),_:1}),o(_,{label:"上传时间",align:"center",width:"200"},{default:n(s=>[d(v(z(s.row.uploadTime)),1)]),_:1}),o(_,{label:"操作",align:"center",width:"120"},{default:n(s=>[o(l,{type:"primary",size:"small",onClick:ae=>V(s.row)},{default:n(()=>[...e[2]||(e[2]=[d(" 预览/下载 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1})):Y("",!0),o(y,{label:"作品文件：",prop:"file"},{default:n(()=>[o(O,{class:"upload-demo",ref_key:"uploadRef",ref:w,action:E,data:{workId:i.workId},"file-list":u.value,"before-upload":S,"on-success":L,"on-error":R,"on-change":T,limit:1,"auto-upload":!1,accept:".zip,.rar,.doc,.docx,.pdf"},{default:n(()=>[o(l,{type:"primary"},{default:n(()=>[...e[3]||(e[3]=[d("选择文件",-1)])]),_:1}),e[4]||(e[4]=c("div",{slot:"tip",class:"el-upload__tip"},[d(" 支持格式：zip/rar、doc/docx、pdf"),c("br"),d(" 单个文件不超过200MB，文件命名格式：作品ID_队伍名称"),c("br")],-1))]),_:1},8,["data","file-list"])]),_:1}),o(y,null,{default:n(()=>[o(l,{type:"primary",onClick:M,loading:p.value},{default:n(()=>[...e[5]||(e[5]=[d(" 提交作品 ",-1)])]),_:1},8,["loading"]),o(l,{onClick:b},{default:n(()=>[...e[6]||(e[6]=[d("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])])}}},oe=G(te,[["__scopeId","data-v-ac00fe93"]]);export{oe as default};
