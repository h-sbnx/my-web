import{_ as A,c as G,a as f,b as o,w as s,r as p,o as D,d as u,h as H,t as k,f as K,j as g,l as Y,E as r,i as C,m as F}from"./index-DWDpl3uH.js";const Z={class:"upload-page"},J={class:"upload-container"},P={class:"workid-input-group"},Q={class:"file-result-container"},X={class:"file-name"},ee="http://116.62.235.114:8080/api/file/upload",te={__name:"UploadView",setup(le){const i=Y({workId:""}),b=g(!1),w=g([]),I=g(!1),m=g(!1),E={workId:[{required:!0,message:"请输入作品ID",trigger:"blur"},{pattern:/^[A-Za-z0-9]+$/,message:"作品ID仅支持字母和数字",trigger:"blur"}],file:[{required:!0,validator:(t,e,l)=>{d.value.length===0?l(new Error("请选择要上传的文件")):l()},trigger:"change"}]},h=g(null),_=g(null),d=g([]),S=async()=>{try{return(await C.get("/file/queryByWorkId",{params:{workId:i.workId}})).code===200}catch{return!1}},x=t=>{const e=t.name;if(!e)return r.error("文件名不能为空！"),!1;if(!i.workId.trim())return r.error("请先填写作品ID再选择文件！"),!1;if(!e.startsWith(i.workId+"_"))return F({title:"格式提示",message:`文件名格式错误！正确格式：${i.workId}_队伍名称`,type:"warning"}),!1;const l=[".zip",".rar",".doc",".docx",".pdf"],a=e.substring(e.lastIndexOf(".")).toLowerCase();return l.includes(a)?!0:(r.error(`文件格式不支持！仅支持：${l.join("、")}`),!1)},M=t=>t.size/1024/1024<200?i.workId.trim()?x(t)?!0:(r.error("文件名校验失败，请检查文件名格式！"),!1):(r.error("请先填写作品ID！"),!1):(r.error("文件大小不能超过200MB！"),!1),N=async()=>{h.value.validate(async t=>{if(!t){r.error("请完善表单信息！");return}if(d.value.length===0){r.warning("请先选择文件！");return}const e=d.value[0].raw||d.value[0];if(!x(e)){r.error("文件校验不通过，无法上传！");return}m.value=!0;const l=await S();if(m.value=!1,!l){r.error("作品ID不存在，无法上传");return}m.value=!0,_.value&&_.value.submit()})},U=t=>{if(m.value=!1,console.log("上传成功返回：",t),!t){r.error("上传结果异常，请检查文件状态"),y();return}t.code===200?F({title:"上传成功",message:`作品上传成功！
文件UUID：${t.data||"未返回"}`,type:"success"}).then(()=>{y(),i.workId?.trim()&&B()}).catch(()=>{y()}):(r.error(`上传失败：${t.message||"未知错误"}`),d.value=[])},L=t=>{m.value=!1;let e="网络异常，请重试";t.response?e=t.response.data?.message||`请求失败（${t.response.status}）`:t.request?e="服务器无响应，请检查网络或联系管理员":e=`请求异常：${t.message||"未知错误"}`,r.error(`上传失败：${e}`),d.value=[]},y=()=>{h.value&&h.value.resetFields(),d.value=[],_.value&&_.value.clearFiles(),w.value=[],I.value=!1,m.value=!1,r.info("表单已重置")},B=async()=>{if(!i.workId.trim()){r.warning("请先输入作品ID！");return}b.value=!0,I.value=!1,w.value=[];try{const t=await C.get("/file/queryByWorkId",{params:{workId:i.workId}});t.code===200?(w.value=t.data||[],I.value=!0,w.value.length===0?r.info("该作品ID暂无已提交的文件"):r.success(`查询成功，共找到 ${w.value.length} 个文件`)):r.error(`查询失败：${t.message||"服务器返回异常"}`)}catch(t){console.error("查询异常详情：",t);const e=t.response?.data?.message||"网络异常，查询失败";r.error(`查询失败：${e}`)}finally{b.value=!1}},V=t=>{if(!t||!t.fileUuid){r.error("文件信息不存在，无法预览/下载");return}const e=`/file/download?fileUuid=${t.fileUuid}`,l=t.originalFileName,a=l.substring(l.lastIndexOf(".")).toLowerCase();a===".pdf"?$(e,!1,l):[".doc",".docx",".zip",".rar"].includes(a)?F.confirm(`是否下载文件：${l}`,"文件下载",{confirmButtonText:"下载",cancelButtonText:"取消"}).then(()=>{$(e,!0,l)}).catch(()=>{r.info("已取消下载")}):$(e,!0,l)},q=t=>{if(!t||t<=0)return"0 B";const e=["B","KB","MB","GB"];let l=0,a=t;for(;a>=1024&&l<e.length-1;)a/=1024,l++;return`${a.toFixed(2)} ${e[l]}`},z=t=>{if(!t)return"-";const e=new Date(t);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},R=(t,e)=>{if(e.length>0){const l=e[0].raw||e[0];if(!x(l)){_.value?.clearFiles(),d.value=[];return}}d.value=e},$=(t,e=!1,l="")=>{try{let a=t;if(t.startsWith("http")||(a=`http://116.62.235.114:8080/api${t}`),e){const c=document.createElement("a");c.href=a,c.download=l||"文件",document.body.appendChild(c),c.click(),document.body.removeChild(c),r.success(`开始下载：${l||"文件"}`)}else window.open(a,"_blank")}catch(a){console.error("文件操作失败：",a),r.error("文件预览/下载失败，请重试")}};return(t,e)=>{const l=p("el-input"),a=p("el-button"),c=p("el-form-item"),v=p("el-table-column"),T=p("el-table"),W=p("el-upload"),O=p("el-form"),j=p("el-card");return D(),G("div",Z,[f("div",J,[e[7]||(e[7]=f("h2",{class:"page-title"},"作品提交",-1)),o(j,{class:"upload-card"},{default:s(()=>[o(O,{model:i,rules:E,ref_key:"uploadFormRef",ref:h,"label-width":"100px",class:"upload-form"},{default:s(()=>[o(c,{label:"作品ID：",prop:"workId"},{default:s(()=>[f("div",P,[o(l,{modelValue:i.workId,"onUpdate:modelValue":e[0]||(e[0]=n=>i.workId=n),placeholder:"请输入作品ID"},null,8,["modelValue"]),o(a,{type:"info",onClick:B,loading:b.value,style:{"margin-left":"10px"}},{default:s(()=>[...e[1]||(e[1]=[u(" 查询已提交作品 ",-1)])]),_:1},8,["loading"])])]),_:1}),I.value?(D(),H(c,{key:0,label:"已提交作品："},{default:s(()=>[f("div",Q,[o(T,{data:w.value,border:"",style:{width:"100%"},"empty-text":"暂无已提交的作品文件",class:"file-table"},{default:s(()=>[o(v,{label:"序号",align:"center",width:"80"},{default:s(n=>[u(k(n.$index+1),1)]),_:1}),o(v,{label:"文件名",prop:"originalFileName","min-width":"200"},{default:s(n=>[f("span",X,k(n.row.originalFileName),1)]),_:1}),o(v,{label:"文件大小",align:"center",width:"120"},{default:s(n=>[u(k(q(n.row.fileSize)),1)]),_:1}),o(v,{label:"文件类型",align:"center",width:"120"},{default:s(n=>[u(k(n.row.fileType||n.row.originalFileName.substring(n.row.originalFileName.lastIndexOf("."))),1)]),_:1}),o(v,{label:"上传时间",align:"center",width:"200"},{default:s(n=>[u(k(z(n.row.uploadTime)),1)]),_:1}),o(v,{label:"操作",align:"center",width:"120"},{default:s(n=>[o(a,{type:"primary",size:"small",onClick:re=>V(n.row)},{default:s(()=>[...e[2]||(e[2]=[u(" 预览/下载 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1})):K("",!0),o(c,{label:"作品文件：",prop:"file"},{default:s(()=>[o(W,{class:"upload-demo",ref_key:"uploadRef",ref:_,action:ee,data:{workId:i.workId,fileType:"work"},"file-list":d.value,"before-upload":M,"on-success":U,"on-error":L,"on-change":R,limit:1,"auto-upload":!1,accept:".zip,.rar,.doc,.docx,.pdf"},{default:s(()=>[o(a,{type:"primary"},{default:s(()=>[...e[3]||(e[3]=[u("选择文件",-1)])]),_:1}),e[4]||(e[4]=f("div",{slot:"tip",class:"el-upload__tip"},[u(" 支持格式：zip/rar、doc/docx、pdf"),f("br"),u(" 单个文件不超过200MB，文件命名格式：作品ID_队伍名称"),f("br")],-1))]),_:1},8,["data","file-list"])]),_:1}),o(c,null,{default:s(()=>[o(a,{type:"primary",onClick:N,loading:m.value},{default:s(()=>[...e[5]||(e[5]=[u(" 提交作品 ",-1)])]),_:1},8,["loading"]),o(a,{onClick:y},{default:s(()=>[...e[6]||(e[6]=[u("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])])}}},oe=A(te,[["__scopeId","data-v-e62752f9"]]);export{oe as default};
